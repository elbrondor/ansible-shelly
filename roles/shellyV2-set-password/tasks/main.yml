---

- name: get shelly basic infos
  ansible.builtin.uri:
    method: get
    url: "http://{{ inventory_hostname }}/shelly"
  delegate_to: localhost
  register: shellyinfo

- name: "Calculate HA1 from the digest response formula - sha256(username:realm:password)"
  ansible.builtin.set_fact:
    digestRequestValues: "{{ digestRequestValues | combine ({ 'HA1' : [shellies.web.user, shellyinfo.json.id, shellies.web.pass] | join(':') | hash('sha256') }) }}"

- name: Set password
  ansible.builtin.uri:
    url: "http://{{ inventory_hostname }}/rpc/Shelly.SetAuth?user=\"{{shellies.web.user}}\"&realm=\"{{shellyinfo.json.id}}\"&ha1=\"{{ digestRequestValues.HA1 }}\""
    method: "GET"  

